<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EsJaxRsSearchBean.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">DoxDB REST API</a> &gt; <a href="index.source.html" class="el_package">net.trajano.doxdb.ejb</a> &gt; <span class="el_source">EsJaxRsSearchBean.java</span></div><h1>EsJaxRsSearchBean.java</h1><pre class="source lang-java linenums">package net.trajano.doxdb.ejb;

import static javax.json.Json.createObjectBuilder;

import java.math.BigDecimal;
import java.util.Map.Entry;

import javax.ejb.Asynchronous;
import javax.ejb.EJB;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.enterprise.context.Dependent;
import javax.json.Json;
import javax.json.JsonArray;
import javax.json.JsonNumber;
import javax.json.JsonObject;
import javax.json.JsonObjectBuilder;
import javax.json.JsonString;
import javax.json.JsonValue;
import javax.persistence.PersistenceException;
import javax.ws.rs.client.Entity;
import javax.ws.rs.client.WebTarget;
import javax.ws.rs.core.MediaType;

import net.trajano.doxdb.DoxID;
import net.trajano.doxdb.IndexView;
import net.trajano.doxdb.SearchResult;
import net.trajano.doxdb.ext.ConfigurationProvider;
import net.trajano.doxdb.schema.IndexType;

/**
 * Handles ElasticSearch via REST API.
 *
 * @author Archimedes Trajano
 */
@Stateless
@Dependent
@LocalBean
<span class="nc" id="L39">public class EsJaxRsSearchBean implements</span>
    DoxSearch {

    /**
     * Create a unique ID for the search index record.
     *
     * @param view
     * @return
     */
    public static String uid(final IndexView view) {

<span class="nc" id="L50">        return view.getIndex() + &quot;\t&quot; + view.getCollection() + &quot;\t&quot; + view.getDoxID();</span>
    }

    private ConfigurationProvider configurationProvider;

    private transient EsJaxRsProvider jestProvider;

    /**
     * {@inheritDoc}
     */
    @Override
    @Asynchronous
    public void addToIndex(final IndexView... indexViews) {

<span class="nc" id="L64">        final WebTarget target = jestProvider.getTarget().path(&quot;_bulk&quot;);</span>

<span class="nc" id="L66">        final StringBuilder b = new StringBuilder();</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        for (final IndexView indexView : indexViews) {</span>
<span class="nc" id="L68">            b.append(</span>
                createObjectBuilder().add(&quot;index&quot;, createObjectBuilder()
                    .add(&quot;_index&quot;, configurationProvider.getMappedIndex(indexView.getIndex()))
                    .add(&quot;_type&quot;, indexView.getCollection())
                    .add(&quot;_id&quot;, indexView.getDoxID().toString())).build().toString());
<span class="nc" id="L73">            b.append(&quot;\n&quot;);</span>

<span class="nc" id="L75">            final JsonObjectBuilder sourceBuilder = createObjectBuilder();</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            for (final Entry&lt;String, BigDecimal&gt; d : indexView.getNumbers()) {</span>
<span class="nc" id="L77">                sourceBuilder.add(d.getKey(), d.getValue());</span>
<span class="nc" id="L78">            }</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">            for (final Entry&lt;String, String&gt; d : indexView.getStrings()) {</span>
<span class="nc" id="L80">                sourceBuilder.add(d.getKey(), d.getValue());</span>
<span class="nc" id="L81">            }</span>

<span class="nc" id="L83">            final JsonObjectBuilder metaBuilder = createObjectBuilder();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            for (final Entry&lt;String, String&gt; d : indexView.getTexts()) {</span>
<span class="nc" id="L85">                metaBuilder.add(d.getKey(), d.getValue());</span>
<span class="nc" id="L86">            }</span>
<span class="nc" id="L87">            metaBuilder.add(&quot;_text&quot;, indexView.getText());</span>
<span class="nc" id="L88">            sourceBuilder.add(&quot;_&quot;, metaBuilder);</span>

<span class="nc" id="L90">            b.append(sourceBuilder.build().toString());</span>
<span class="nc" id="L91">            b.append(&quot;\n&quot;);</span>
        }
<span class="nc" id="L93">        target.request(MediaType.APPLICATION_JSON).post(Entity.entity(b.toString(), MediaType.APPLICATION_OCTET_STREAM)).readEntity(JsonObject.class);</span>

<span class="nc" id="L95">    }</span>

    @Override
    public SearchResult advancedSearch(final String sourceIndex,

        final JsonObject query) {

<span class="nc" id="L102">        final String index = configurationProvider.getMappedIndex(sourceIndex);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (index == null) {</span>
<span class="nc" id="L104">            throw new PersistenceException(&quot;index not found&quot;);</span>
        }

<span class="nc" id="L107">        final SearchResult result = new SearchResult();</span>

<span class="nc" id="L109">        final JsonObject results = jestProvider.getTarget().path(index).path(&quot;_search&quot;).request(MediaType.APPLICATION_JSON).post(Entity.entity(query, MediaType.APPLICATION_JSON)).readEntity(JsonObject.class);</span>

<span class="nc" id="L111">        final JsonArray hits = results.getJsonObject(&quot;hits&quot;).getJsonArray(&quot;hits&quot;);</span>
<span class="nc" id="L112">        result.setTotalHits(results.getJsonObject(&quot;hits&quot;).getInt(&quot;total&quot;));</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">        for (final JsonValue hitValue : hits) {</span>
<span class="nc" id="L114">            final IndexView iv = new IndexView();</span>
<span class="nc" id="L115">            final JsonObject hit = (JsonObject) hitValue;</span>
<span class="nc" id="L116">            iv.setDoxID(new DoxID(hit.getString(&quot;_id&quot;)));</span>
<span class="nc" id="L117">            iv.setCollection(hit.getString(&quot;_type&quot;));</span>

<span class="nc bnc" id="L119" title="All 2 branches missed.">            for (final Entry&lt;String, JsonValue&gt; entry : hit.getJsonObject(&quot;_source&quot;).entrySet()) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                if (entry.getValue() instanceof JsonNumber) {</span>
<span class="nc" id="L121">                    iv.setNumber(entry.getKey(), ((JsonNumber) entry.getValue()).bigDecimalValue());</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                } else if (entry.getValue() instanceof JsonString) {</span>
<span class="nc" id="L123">                    iv.setString(entry.getKey(), ((JsonString) entry.getValue()).getString());</span>
                }
<span class="nc" id="L125">            }</span>
<span class="nc" id="L126">            result.addHit(iv);</span>
<span class="nc" id="L127">        }</span>

<span class="nc" id="L129">        return result;</span>
    }

    @Override
    public SearchResult advancedSearch(final String sourceIndex,
        final String collectionName,
        final JsonObject query) {

<span class="nc" id="L137">        final String index = configurationProvider.getMappedIndex(sourceIndex);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (index == null) {</span>
<span class="nc" id="L139">            throw new PersistenceException(&quot;index not found&quot;);</span>
        }

<span class="nc" id="L142">        final SearchResult result = new SearchResult();</span>

<span class="nc" id="L144">        final JsonObject results = jestProvider.getTarget().path(index).path(collectionName).path(&quot;_search&quot;).request(MediaType.APPLICATION_JSON).post(Entity.entity(query, MediaType.APPLICATION_JSON)).readEntity(JsonObject.class);</span>

<span class="nc" id="L146">        final JsonArray hits = results.getJsonObject(&quot;hits&quot;).getJsonArray(&quot;hits&quot;);</span>
<span class="nc" id="L147">        result.setTotalHits(results.getJsonObject(&quot;hits&quot;).getInt(&quot;total&quot;));</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        for (final JsonValue hitValue : hits) {</span>
<span class="nc" id="L149">            final IndexView iv = new IndexView();</span>
<span class="nc" id="L150">            final JsonObject hit = (JsonObject) hitValue;</span>
<span class="nc" id="L151">            iv.setDoxID(new DoxID(hit.getString(&quot;_id&quot;)));</span>
<span class="nc" id="L152">            iv.setCollection(hit.getString(&quot;_type&quot;));</span>

<span class="nc bnc" id="L154" title="All 2 branches missed.">            for (final Entry&lt;String, JsonValue&gt; entry : hit.getJsonObject(&quot;_source&quot;).entrySet()) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                if (entry.getValue() instanceof JsonNumber) {</span>
<span class="nc" id="L156">                    iv.setNumber(entry.getKey(), ((JsonNumber) entry.getValue()).bigDecimalValue());</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                } else if (entry.getValue() instanceof JsonString) {</span>
<span class="nc" id="L158">                    iv.setString(entry.getKey(), ((JsonString) entry.getValue()).getString());</span>
                }
<span class="nc" id="L160">            }</span>
<span class="nc" id="L161">            result.addHit(iv);</span>
<span class="nc" id="L162">        }</span>

<span class="nc" id="L164">        return result;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void removeFromIndex(final String schemaName,
        final DoxID doxID) {

<span class="nc" id="L174">        final WebTarget target = jestProvider.getTarget().path(&quot;_bulk&quot;);</span>
<span class="nc" id="L175">        final StringBuilder b = new StringBuilder();</span>

<span class="nc bnc" id="L177" title="All 2 branches missed.">        for (final IndexType indexType : configurationProvider.getPersistenceConfig().getIndex()) {</span>

<span class="nc" id="L179">            b.append(</span>
                createObjectBuilder().add(&quot;delete&quot;, createObjectBuilder()
                    .add(&quot;_index&quot;, configurationProvider.getMappedIndex(indexType.getName()))
                    .add(&quot;_type&quot;, schemaName)
                    .add(&quot;_id&quot;, doxID.toString())).build().toString());
<span class="nc" id="L184">            b.append(&quot;\n&quot;);</span>
<span class="nc" id="L185">        }</span>

<span class="nc" id="L187">        target.request(MediaType.APPLICATION_JSON).post(Entity.entity(b.toString(), MediaType.APPLICATION_OCTET_STREAM)).readEntity(JsonObject.class);</span>
<span class="nc" id="L188">    }</span>

    /**
     * {@inheritDoc} Once the indices are removed,
     * {@link EsJaxRsProvider#init()} is called in order to recreate the
     * mappings again.
     */
    @Override
    public void reset() {

<span class="nc bnc" id="L198" title="All 2 branches missed.">        for (final IndexType indexType : configurationProvider.getPersistenceConfig().getIndex()) {</span>

<span class="nc" id="L200">            final WebTarget target = jestProvider.getTarget().path(configurationProvider.getMappedIndex(indexType.getName()));</span>
<span class="nc" id="L201">            target.request(MediaType.APPLICATION_JSON).delete().readEntity(JsonObject.class);</span>

<span class="nc" id="L203">        }</span>
<span class="nc" id="L204">        jestProvider.init();</span>
<span class="nc" id="L205">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public SearchResult search(final String sourceIndex,
        final String queryString,
        final int limit,
        final Integer fromDoc) {

<span class="nc" id="L216">        final String index = configurationProvider.getMappedIndex(sourceIndex);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (index == null) {</span>
<span class="nc" id="L218">            throw new PersistenceException(&quot;index not found&quot;);</span>
        }

<span class="nc" id="L221">        int from = 0;</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (fromDoc != null) {</span>
<span class="nc" id="L223">            from = fromDoc;</span>
        }

<span class="nc" id="L226">        final SearchResult result = new SearchResult();</span>

<span class="nc" id="L228">        final JsonObjectBuilder sqsBuilder = Json.createObjectBuilder().add(&quot;query&quot;, queryString).add(&quot;default_operator&quot;, &quot;and&quot;);</span>
<span class="nc" id="L229">        final JsonObjectBuilder qBuilder = Json.createObjectBuilder().add(&quot;simple_query_string&quot;, sqsBuilder);</span>
<span class="nc" id="L230">        final JsonObjectBuilder queryBuilder = Json.createObjectBuilder().add(&quot;size&quot;, limit).add(&quot;query&quot;, qBuilder).add(&quot;from&quot;, from);</span>

<span class="nc" id="L232">        final JsonObject results = jestProvider.getTarget().path(index).path(&quot;_search&quot;).request(MediaType.APPLICATION_JSON).post(Entity.entity(queryBuilder.build(), MediaType.APPLICATION_JSON)).readEntity(JsonObject.class);</span>

<span class="nc" id="L234">        final JsonArray hits = results.getJsonObject(&quot;hits&quot;).getJsonArray(&quot;hits&quot;);</span>
<span class="nc" id="L235">        result.setTotalHits(results.getJsonObject(&quot;hits&quot;).getInt(&quot;total&quot;));</span>
<span class="nc" id="L236">        result.setBottomDoc(Math.min(from + hits.size(), from + limit));</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">        for (final JsonValue hitValue : hits) {</span>
<span class="nc" id="L238">            final IndexView iv = new IndexView();</span>
<span class="nc" id="L239">            final JsonObject hit = (JsonObject) hitValue;</span>
<span class="nc" id="L240">            iv.setDoxID(new DoxID(hit.getString(&quot;_id&quot;)));</span>
<span class="nc" id="L241">            iv.setCollection(hit.getString(&quot;_type&quot;));</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">            for (final Entry&lt;String, JsonValue&gt; entry : hit.getJsonObject(&quot;_source&quot;).entrySet()) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                if (entry.getValue() instanceof JsonNumber) {</span>
<span class="nc" id="L245">                    iv.setNumber(entry.getKey(), ((JsonNumber) entry.getValue()).bigDecimalValue());</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">                } else if (entry.getValue() instanceof JsonString) {</span>
<span class="nc" id="L247">                    iv.setString(entry.getKey(), ((JsonString) entry.getValue()).getString());</span>
                }
<span class="nc" id="L249">            }</span>
<span class="nc" id="L250">            result.addHit(iv);</span>
<span class="nc" id="L251">        }</span>

<span class="nc" id="L253">        return result;</span>

    }

    /**
     * {@inheritDoc}
     */
    @Override
    public SearchResult searchWithSchemaName(final String sourceIndex,
        final String schemaName,
        final String queryString,
        final int limit,
        final Integer fromDoc) {

<span class="nc" id="L267">        final String index = configurationProvider.getMappedIndex(sourceIndex);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (index == null) {</span>
<span class="nc" id="L269">            throw new PersistenceException(&quot;index not found&quot;);</span>
        }

<span class="nc" id="L272">        int from = 0;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (fromDoc != null) {</span>
<span class="nc" id="L274">            from = fromDoc;</span>
        }

<span class="nc" id="L277">        final SearchResult result = new SearchResult();</span>

<span class="nc" id="L279">        final JsonObjectBuilder sqsBuilder = Json.createObjectBuilder().add(&quot;query&quot;, queryString).add(&quot;default_operator&quot;, &quot;and&quot;);</span>
<span class="nc" id="L280">        final JsonObjectBuilder qBuilder = Json.createObjectBuilder().add(&quot;simple_query_string&quot;, sqsBuilder);</span>
<span class="nc" id="L281">        final JsonObjectBuilder queryBuilder = Json.createObjectBuilder()</span>
            .add(&quot;size&quot;, limit)
            .add(&quot;query&quot;, qBuilder)
            .add(&quot;from&quot;, from);

<span class="nc" id="L286">        final JsonObject results = jestProvider.getTarget().path(index).path(schemaName).path(&quot;_search&quot;).request(MediaType.APPLICATION_JSON).post(Entity.entity(queryBuilder.build(), MediaType.APPLICATION_JSON)).readEntity(JsonObject.class);</span>

<span class="nc" id="L288">        final JsonArray hits = results.getJsonObject(&quot;hits&quot;).getJsonArray(&quot;hits&quot;);</span>
<span class="nc" id="L289">        result.setTotalHits(results.getJsonObject(&quot;hits&quot;).getInt(&quot;total&quot;));</span>
<span class="nc" id="L290">        result.setBottomDoc(Math.min(from + hits.size(), from + limit));</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        for (final JsonValue hitValue : hits) {</span>
<span class="nc" id="L292">            final IndexView iv = new IndexView();</span>
<span class="nc" id="L293">            final JsonObject hit = (JsonObject) hitValue;</span>
<span class="nc" id="L294">            iv.setDoxID(new DoxID(hit.getString(&quot;_id&quot;)));</span>
<span class="nc" id="L295">            iv.setCollection(hit.getString(&quot;_type&quot;));</span>

<span class="nc bnc" id="L297" title="All 2 branches missed.">            for (final Entry&lt;String, JsonValue&gt; entry : hit.getJsonObject(&quot;_source&quot;).entrySet()) {</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                if (entry.getValue() instanceof JsonNumber) {</span>
<span class="nc" id="L299">                    iv.setNumber(entry.getKey(), ((JsonNumber) entry.getValue()).bigDecimalValue());</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                } else if (entry.getValue() instanceof JsonString) {</span>
<span class="nc" id="L301">                    iv.setString(entry.getKey(), ((JsonString) entry.getValue()).getString());</span>
                }
<span class="nc" id="L303">            }</span>
<span class="nc" id="L304">            result.addHit(iv);</span>
<span class="nc" id="L305">        }</span>

<span class="nc" id="L307">        return result;</span>

    }

    /**
     * Sets configurationProvider.
     *
     * @param configurationProvider
     *            the configurationProvider to set
     */
    @EJB
    public void setConfigurationProvider(final ConfigurationProvider configurationProvider) {

<span class="nc" id="L320">        this.configurationProvider = configurationProvider;</span>
<span class="nc" id="L321">    }</span>

    /**
     * Sets provider.
     *
     * @param provider
     *            the provider to set
     */
    @EJB
    public void setJestProvider(final EsJaxRsProvider provider) {

<span class="nc" id="L332">        jestProvider = provider;</span>
<span class="nc" id="L333">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>